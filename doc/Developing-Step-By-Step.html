<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
<link type="text/css" rel="stylesheet" href="bootstrap.min.css" />
<title>Developing an Application Step By Step</title>
</head>

<body>

<h3>Introduction</h3>

<p>In this document, we will create a sample <strong>phonebook application</strong> 
based on ASP.NET Zero step by step. Once complete, we will have a 
multi-tenant, localized, authorized, configurable, testable... application.</p>

<div class="bs-callout bs-callout-warning">
	<h4>Project Type ...?</h4>
	<p>There are three versions of this tutorial. This one is for the <b>SPA</b> 
	(Single-Page Application) with <strong>AngularJS.</strong><br />
    <ul>
        <li><a href="Developing-Step-By-Step-Core.html">Click here</a> to read the MPA (Multi-Page Application) version with ASP.NET Core and jQuery.</li>
        <li><a href="Developing-Step-By-Step-MPA.html">Click here</a> to read the MPA (Multi-Page Application) version ASP.NET MVC, ASP.NET Web API and jQuery.</li>
    </ul>
	</p>
</div>

<h3>Creating The Project</h3>
<p>You will be creating and downloading the solution named "<strong>Acme.PhoneBook</strong>" as described in the
<a href="Getting-Started.html">Getting Started</a> document. After opening the 
solution in Visual Studio, you will see an NLayered solution that consists of six projects:</p>
<p>

<img class="img-thumbnail" alt="Solution Overall" height="166" src="images/solution-overall.png" width="249" /></p>
<p>

Once opened, run the database migrations, create the database, and login to the application 
as described in the <a href="Getting-Started.html">Getting Started</a> document. 
Once that is done and you are logged in to the application, you will see a dashboard as 
shown below:</p>
<p>

<img class="img-thumbnail" alt="Dashboard" height="484" src="images/default-dashboard.png" width="800" /></p>
<p>

Let's start by making the application <strong>single-tenant</strong> (you will convert it 
to multi-tenant later). So, 
open the <strong>PhoneBookCoreModule</strong> class (in the Core Project, root level) and disable multi-tenancy as 
shown below:</p>
<pre lang="cs">[DependsOn(typeof(AbpZeroCoreModule))]
public class PhoneBookCoreModule : AbpModule
{
    public override void PreInitialize()
    {
        //Enable this line to create a multi-tenant application.
        //Configuration.MultiTenancy.IsEnabled = true;
    }
}</pre>

<h3>Adding a New Page</h3>
<p>Let's begin with the UI (Web Project) and create a new page named "<strong>Phone book</strong>".</p>
<h4>Defining a menu item</h4>
<p><strong>AppNavigationProvider</strong> class (in the Web Project, under Startup) defines menus in the application. When 
you change this class, the menus are automatically updated. Open this class and 
create a new menu item as shown below.</p>
<pre lang="cs">.AddItem(new MenuItemDefinition(
    PageNames.App.Tenant.PhoneBook,
    L("PhoneBook"),
    url: "tenant.phonebook",
    icon: "glyphicon glyphicon-book"
    )
)</pre>
<p>Every menu item must have a <strong>unique name</strong> 
to identify it. Menu names are defined in the PageNames class as 
constants. So you should add a new constant: "<strong>PhoneBook</strong>".</p>
<h4>Localizing Menu Item Display Name</h4>
<p>A menu item should also have a <strong>localizable display name</strong>. It is 
used to display menu item on the page. <strong>L("PhoneBook")</strong> is the localized name of 
your new menu. <strong>L</strong> method is a helper method gets a localization 
key and simply returns a <strong>LocalizableString</strong> object (see 
AppNavigationProvider class).</p>
<p>Localization strings are defined in <strong>XML</strong> files in <strong>
.Core</strong> 
project as shown below:</p>
<p>
<img class="img-thumbnail" alt="Localization files" height="151" src="images/localization-files-2.png" width="202" /></p>
<p>Open PhoneBook.xml (the <strong>default</strong>, <strong>English</strong> 
localization dictionary) and add the following line:</p>
<pre lang="xml">&lt;text name=&quot;PhoneBook&quot; value=&quot;Phone book&quot; /&gt;</pre>
<p>If you do not define "PhoneBook"s value for other localization dictionaries, a 
default value is shown in all languages. You could also define it for other languages as needed - for example you should define it for Turkish in the 
PhoneBook-tr.xml file:</p>
<pre lang="xml">&lt;text name=&quot;PhoneBook&quot; value=&quot;Telefon rehberi&quot; /&gt;</pre>
<h4>Other menu item properties</h4>
<p>The <strong>url</strong> can be a URL or an <strong>AngularJs route</strong> (i.e. state 
in Angular <strong>ui-router</strong> is used in ASP.NET Zero) that will be 
activated when someone clicks the menu item. See defining this route below.</p>
<p>Last, the <strong>icon</strong> is the menu icon that will be displayed for new menu item. It 
can be a <strong>CSS</strong> class. You can use Glyphicon, Font-Awesome or 
another CSS font library here.</p>
<p>See the <a href="http://www.aspnetboilerplate.com/Pages/Documents/Navigation">
navigation document</a> for more information on menu definitions.</p>
<h3>Creating AngularJs Routes</h3>
<p>Angular JS routes are defined in <strong>app.js</strong>. Add a new 
route definition as shown below:</p>
<pre lang="js">$stateProvider.state(&#39;tenant.phonebook&#39;, {
    url: &#39;/phonebook&#39;,
    templateUrl: &#39;~/App/tenant/views/phonebook/index.cshtml&#39;
});</pre>
<p>'<strong>tenant.phonebook</strong>' is the <strong>unique</strong> name of 
this state (route). <strong>url</strong> is the mapped URL to this route and
<strong>templateUrl</strong> is the view path for this route.</p>
<p>Note that 'tenant.phonebook' is a <strong>second level state</strong> (child 
of 'tenant' abstract state). See Angular-UI's route documentation for more 
information on defining states. In most cases you can define it easily by 
using existing routes as reference.</p>
<h3>Creating AngularJs View and Controller</h3>
<p>The last step to see your new page is to create an AngularJS view and 
controller for it:</p>
<p>
<img class="img-thumbnail" alt="Phonebook AngularJs controller and view" height="198" src="images/phonebook-controller-views-files.png" width="171" /></p>
<p>
You can clone the <strong>empty</strong> controller and view located under <strong>
common/views/_empty</strong> folder to simplify creating a new view.</p>
<h4>Controller</h4>
<p>Creating an empty Controller file, <strong>index.js</strong> under <strong>App/tenant/views/phonebook</strong> 
folder:</p>
<pre lang="js">(function() {
    appModule.controller(&#39;<strong>tenant.views.phonebook.index</strong>&#39;, [
        &#39;$scope&#39;,
        function ($scope) {
            var vm = this;

            $scope.$on(&#39;$viewContentLoaded&#39;, function () {
                Metronic.initAjax();
            });

            //...
        }
    ]);
})();</pre>
<p>This is the minimum controller definition that creates a controller named '<strong>tenant.views.phonebook.index</strong>' 
and triggers Metronic's init method for this page. The controller name is completely 
arbitrary. You can set it to any string. However, ASP.NET Zero uses this <strong>naming convention</strong> 
and it is recommended that you follow this convention when developing applications based on 
ASP.NET Zero.</p>
<h4>View</h4>
<p>Creating an empty view, <strong>index.cshtml</strong> under <strong>App/tenant/views/phonebook</strong> 
folder:</p>
<pre lang="xml">&lt;div ng-controller=&quot;<strong>tenant.views.phonebook.index as vm</strong>&quot;&gt;
    &lt;div class=&quot;row margin-bottom-5&quot;&gt;
        &lt;div class=&quot;col-xs-12&quot;&gt;
            &lt;div class=&quot;page-head&quot;&gt;
                &lt;div class=&quot;page-title&quot;&gt;
                    &lt;h1&gt;
                        &lt;span&gt;<strong>@L(&quot;PhoneBook&quot;)</strong>&lt;/span&gt;
                    &lt;/h1&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;portlet light&quot;&gt;
        &lt;div class=&quot;portlet-body&quot;&gt;

            &lt;p&gt;PHONE BOOK CONTENT COMES HERE!&lt;/p&gt;

        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;</pre>
<p>You can use <strong>.cshtml (Razor)</strong> files as views (thanks to ABP 
framework) to get easy localization <strong>--</strong> conditionally 
creating some part of the view (based on some user permissions for example) and 
so on. It is not necessary to fully understand the HTML structure for this tutorial -- you can simple copy the empty 
view from<strong>
common/views/_empty</strong> folder.</p>
<p>Now it is time to run the application and see the new phone book page:</p>
<p>
<img class="img-thumbnail" alt="Empty page" height="195" src="images/phonebook-page-empty.png" width="720" /></p>
<p>The menu item display name and page title are localized. Try to change the UI 
language setting to see the difference.</p>


<h3>Creating Person Entity</h3>
<p>In ASP.NET Zero, you define entities in the <strong>.Core</strong> (domain) project. You can define a <strong>Person</strong> entity (mapped to <strong>PbPersons</strong> 
table in database) to represent a person in the phone book as shown below:</p>
<pre lang="cs">[Table(&quot;PbPersons&quot;)]
public class Person : FullAuditedEntity
{
    public const int MaxNameLength = 32;
    public const int MaxSurnameLength = 32;
    public const int MaxEmailAddressLength = 255;

    [Required]
    [MaxLength(MaxNameLength)]
    public virtual string Name { get; set; }

    [Required]
    [MaxLength(MaxSurnameLength)]
    public virtual string Surname { get; set; }

    [MaxLength(MaxEmailAddressLength)]
    public virtual string EmailAddress { get; set; }
}</pre>
<p>Person's <strong>primary key</strong> 
type is an <strong>int </strong>(as default). It inherits from <strong>FullAuditedEntity</strong> which 
contains <strong>creation</strong>, <strong>modification </strong>and <strong>
deletion </strong>audit properties. It is also <strong>soft-delete</strong>. When 
 a Person is deleted, it is not deleted from the database but instead marked as deleted (see
<a href="http://www.aspnetboilerplate.com/Pages/Documents/Entities">entity</a> 
and <a href="http://www.aspnetboilerplate.com/Pages/Documents/Data-Filters">data 
filters</a> documentation for more information). Constants are created to implement <strong>
MaxLength</strong> properties. This is a good practice since you can use the same 
values later.</p>
<p>Next add a DbSet property for the Person entity to the <strong>PhoneBookDbContext</strong> 
class defined in <strong>.EntityFramework</strong> project.</p>

<pre lang="cs">public class PhoneBookDbContext : AbpZeroDbContext&lt;Tenant, Role, User&gt;
{
<strong>    public virtual IDbSet&lt;Person&gt; Persons { get; set; }
</strong>        
    //...other entities

    public PhoneBookDbContext()
        : base(&quot;Default&quot;)
    {

    }
    
    //...other code
}</pre>


<h3>Database Migrations</h3>
<p>Use <strong>EntityFramework Code-First migrations</strong> to migrate the 
database schema. Since you added the <strong>Person entity</strong>, your DbContext 
model is changed. Therefore, you
should create a <strong>new migration</strong> to create the new table in the 
database.</p>
<p>After opening <strong>Package Manager Console</strong> and selecting <strong>
.EntityFramework</strong> as the <strong>default project</strong>, type the 
following command:</p>
<p>
<img class="img-thumbnail" alt="Entity Framework Code First Migration" height="68" src="images/phonebook-migrations-1.png" width="609" /></p>
<p>This command will add a <strong>migration class</strong> named "<strong>Added_Persons_Table</strong>" as shown below:</p>

<pre lang="cs">public partial class <strong>Added_Persons_Table</strong> : DbMigration
{
    public override void Up()
    {
        CreateTable(
            &quot;dbo.<strong>PbPersons</strong>&quot;,
            c =&gt; new
                {
                    Id = c.Int(nullable: false, identity: true),
                    Name = c.String(nullable: false, maxLength: 32),
                    Surname = c.String(nullable: false, maxLength: 32),
                    EmailAddress = c.String(maxLength: 255),
                    IsDeleted = c.Boolean(nullable: false),
                    DeleterUserId = c.Long(),
                    DeletionTime = c.DateTime(),
                    LastModificationTime = c.DateTime(),
                    LastModifierUserId = c.Long(),
                    CreationTime = c.DateTime(nullable: false),
                    CreatorUserId = c.Long(),
                },
            annotations: new Dictionary&lt;string, object&gt;
            {
                { &quot;DynamicFilter_Person_SoftDelete&quot;, &quot;EntityFramework.DynamicFilters.DynamicFilterDefinition&quot; },
            })
            .PrimaryKey(t =&gt; t.Id);
            
    }
        
    public override void Down()
    {
        DropTable(&quot;dbo.PbPersons&quot;,
            removedAnnotations: new Dictionary&lt;string, object&gt;
            {
                { &quot;DynamicFilter_Person_SoftDelete&quot;, &quot;EntityFramework.DynamicFilters.DynamicFilterDefinition&quot; },
            });
    }
}</pre>
<p>It is not necessary to know much about the format and rules of this file although you should have a basic understanding of migrations. In the same Package 
Manager Console, enter "<strong>Update-Database</strong>" in order to 
apply the new migration to the database. After updating, you can verify that <strong>PbPersons 
table</strong> is added to the database.</p>
<p>
<img class="img-thumbnail" alt="PhoneBook tables" height="302" src="images/phonebook-tables.png" width="190" /></p>
<p>This new table is empty. You should use EntityFramework's <strong>Seed</strong> 
method to add some initial data to the database. In ASP.NET Zero, there are some 
classes to create initial data for users and settings:</p>
<p>
<img class="img-thumbnail" alt="Entity Framework seed data" height="119" src="images/phonebook-seed-files.png" width="283" /></p>
<p>Thus you can add a separate class to add some initial people to the database 
as shown below:</p>
<pre lang="cs">public class InitialPeopleCreator
{
    private readonly PhoneBookDbContext _context;

    public InitialPeopleCreator(PhoneBookDbContext context)
    {
        _context = context;
    }

    public void Create()
    {
        var douglas = _context.Persons.FirstOrDefault(p =&gt; p.EmailAddress == &quot;douglas.adams@fortytwo.com&quot;);
        if (douglas == null)
        {
            _context.Persons.Add(
                new Person
                {
                    Name = &quot;Douglas&quot;,
                    Surname = &quot;Adams&quot;,
                    EmailAddress = &quot;douglas.adams@fortytwo.com&quot;
                });
        }

        var asimov = _context.Persons.FirstOrDefault(p =&gt; p.EmailAddress == &quot;isaac.asimov@foundation.org&quot;);
        if (asimov == null)
        {
            _context.Persons.Add(
                new Person
                {
                    Name = &quot;Isaac&quot;,
                    Surname = &quot;Asimov&quot;,
                    EmailAddress = &quot;isaac.asimov@foundation.org&quot;
                });
        }
    }
}</pre>
<p>This type of default data is good since you can also use such data with
<strong>unit 
tests</strong>. Of course, you should be careful about seed data since this code will always 
be executed after each <strong>Update-Database</strong> command (see the EntityFramework 
documentation to learn more about seed data). This class is created and called 
in the <strong>InitialDbBuilder</strong> class, and it is called from 
EntityFramework's <strong>Configuration</strong> class. It is not critical but is useful for a good code organization (see source code).</p>

<p>Execute the <strong>Update-Database</strong> command again. This command seeds two people into the PbPersons table:</p>
<p>
<img class="img-thumbnail" alt="Persons initial data" height="50" src="images/phonebook-persons-table-initial-data.png" width="720" /></p>
<h3>Creating Person Application Service</h3>
<p>An Application Service is used from the client (presentation layer) to perform 
operations (use cases) in the application.</p>
<p>Application services are located in the
<strong>.Application</strong> project. First create an application service to 
get people from the server. Create an <strong>interface</strong> to define 
the person application service:</p>
<pre lang="cs">public interface IPersonAppService : IApplicationService
{
    ListResultOutput&lt;PersonListDto&gt; GetPeople(GetPeopleInput input);
}</pre>
<p>An application service method gets/returns <strong>DTO</strong>s. <strong>ListResultOutput</strong> is a 
pre-build helper DTO to return a list of another DTO. <strong>GetPeopleInput</strong> is a DTO to pass 
request parameters to the <strong>GetPeople</strong> method. GetPeopleIntput and PersonListDto 
are defined as shown below:</p>

<pre lang="cs">public class GetPeopleInput : <strong>IInputDto</strong>
{
    public string Filter { get; set; }
}

[<strong>AutoMapFrom(typeof(Person))</strong>]
public class PersonListDto : <strong>FullAuditedEntityDto</strong>
{
    public string Name { get; set; }

    public string Surname { get; set; }

    public string EmailAddress { get; set; }
}</pre>
<p>Implementing <strong>IInputDto</strong> interface is a convention in ABP for 
input DTOs. It provides automatic 
validation (which you will use later). <strong>AutoMapFrom</strong> attribute is used to configure 
<strong>AutoMapper</strong> to create mapping from 
<strong>Person</strong> to <strong>PersonListDto</strong>. <strong>FullAuditedEntityDto</strong> is used to inherit audit properties 
automatically. See
<a href="http://www.aspnetboilerplate.com/Pages/Documents/Application-Services">
application service</a> and
<a href="http://www.aspnetboilerplate.com/Pages/Documents/Data-Transfer-Objects">
DTO</a> documentation for more information.</p>
<p>After defining the interface, you can implement it as shown below:</p>
<pre lang="cs">public class PersonAppService : PhoneBookAppServiceBase, IPersonAppService
{
    private readonly IRepository&lt;Person&gt; _personRepository;

    public PersonAppService(IRepository&lt;Person&gt; personRepository)
    {
        _personRepository = personRepository;
    }

    public ListResultOutput&lt;PersonListDto&gt; GetPeople(GetPeopleInput input)
    {
        var persons = _personRepository
            .GetAll()
            .<strong>WhereIf</strong>(
                !input.Filter.IsNullOrEmpty(),
                p =&gt; p.Name.Contains(input.Filter) ||
                        p.Surname.Contains(input.Filter) ||
                        p.EmailAddress.Contains(input.Filter)
            )
            .OrderBy(p =&gt; p.Name)
            .ThenBy(p =&gt; p.Surname)
            .ToList();

        return new ListResultOutput&lt;PersonListDto&gt;(persons.<strong>MapTo</strong>&lt;List&lt;PersonListDto&gt;&gt;());
    }
}</pre>
<p>We're injecting <strong>person repository</strong> (it's automatically created by ABP) and 
using it to filter and get people from database. </p>
<p><strong>WhereIf</strong> is an extension method 
here (defined in Abp.Linq.Extensions namespace). It performs Where condition, only if filter is not null or empty.
<strong>IsNullOrEmpty</strong> is also an extension method (defined in 
Abp.Extensions namespace). ABP has 
many similar 
shortcut extension methods. <strong>MapTo</strong> method automatically 
converts list of Person entities to list of PersonListDto entities using <strong>AutoMapper</strong> library.</p>
<h4>Connection &amp; Transaction Management</h4>
<p>We don't manually open database connection or start/commit transactions 
manually. It's automatically done with ABP framework's Unit Of Work system. See
<a href="http://www.aspnetboilerplate.com/Pages/Documents/Unit-Of-Work">UOW 
documentation</a> for more.</p>
<h4>Exception Handling</h4>
<p>We don't handle exceptions manually (using a try-catch block). Because ABP 
framework automatically handles all exceptions on the web layer and returns 
appropriate error messages to the client. It then handles errors on the client 
and shows needed error information to the user. See
<a href="http://www.aspnetboilerplate.com/Pages/Documents/Handling-Exceptions">
exception handling document</a> for more.</p>

<h3>Creating Unit Tests For PersonAppService</h3>
<p>You can skip this section if you don't interest in <strong>automated testing</strong>.</p>
<p>By writing unit test, we can test <strong>PersonAppService.GetPeople</strong> 
method without creating a user interface that calls it and shows people on the 
screen.</p>
<p>We write unit test in .<strong>Tests</strong> project in the solution. Let's 
create first test to verify getting people without any filter:</p>
<pre lang="cs">public class PersonAppService_Tests : AppTestBase
{
    private readonly IPersonAppService _personAppService;

    public PersonAppService_Tests()
    {
        _personAppService = Resolve&lt;IPersonAppService&gt;();
    }

    [Fact]
    public void Should_Get_All_People_Without_Any_Filter()
    {
        //Act
        var persons = _personAppService.GetPeople(new GetPeopleInput());
            
        //Assert
        persons.Items.Count.ShouldBe(2);
    }
}</pre>
<p>We derived test class from <strong>AppTestBase</strong>. AppTestBase class 
initializes all system, creates an in-memory fake database, seeds initial data 
(that we created before) to database and logins to application as admin. So, this is 
actually an <strong>integration test</strong> since it tests all server-side 
codes from entitiy framework mapping to application services, validation and 
authorization.</p>

<p>In constructor, we get (resolve) an <strong>IPersonAppService</strong> from
<strong>dependency injection</strong> container. It creates the <strong>
PersonAppService</strong> class with all dependencies. Then we can use it in 
test methods.</p>
<p>Since we're using <a href="http://xunit.github.io/" target="_blank">xUnit</a>, 
we add <strong>Fact</strong> attribute to each test method. In the test method, 
we called <strong>GetPeople</strong> method and checked if there are <strong>two 
people</strong> in the returned list as we know that there were 2 people in
<strong>initial</strong> database.</p>
<p>Let's run the <strong>all unit tests</strong> in Test Explorer and see if it 
works:</p>
<p>
<img class="img-thumbnail" alt="xUnit unit test success" height="40" src="images/phone-book-unit-test-success-1.png" width="750" /></p>
<p>As you see, it worked <strong>successfully</strong>. Now, we know that 
PersonAppService works properly without any filter. Let's add a new unit test to 
get filtered people:</p>
<pre lang="cs">[Fact]
public void Should_Get_People_With_Filter()
{
    //Act
    var persons = _personAppService.GetPeople(
        new GetPeopleInput
        {
            Filter = &quot;adams&quot;
        });

    //Assert
    persons.Items.Count.ShouldBe(1);
    persons.Items[0].Name.ShouldBe(&quot;Douglas&quot;);
    persons.Items[0].Surname.ShouldBe(&quot;Adams&quot;);
}</pre>
<p>Again, since we know initial database, we can check returned results easily. 
Here, initial test data is important. When we change initial data, our test may 
fail even if our services are correct. So, it's better to write unit tests 
independed of initial data as much as possible. We could check incoming data to 
see if every people contains "adams" in his/her name, surname or email. Thus, if 
we add new people to initial data, our tests remain working.</p>
<p>There are many techniques on unit testing, I kept it simple here. But ASP.NET 
Zero template makes very easy to write unit and integration tests by base 
classes and pre-build test codes.</p>
<h3>Testing PersonAppService From Browser Console</h3>
<p>Now, lets run and <strong>login</strong> to the application again, open 
Chrome Developer Console (or similar tools in other browsers) and write the 
following command:</p>
<p>
<img class="img-thumbnail" alt="Google Chrome Console AJAX" height="104" src="images/chrome-console-get-people.png" width="497" /></p>
<p>This command performs an <strong>AJAX</strong> call to PersonAppService.<strong>GetPeople</strong> 
method. We can see the request if we open <strong>Network</strong> tab:</p>
<p>
<img class="img-thumbnail" alt="Google Chrome Console Get People" height="148" src="images/chrome-console-get-people-network.png" width="720" /></p>
<p>As we see, an AJAX request made and people are got successfully.</p>
<p>So, how this happen? How we could call to a C# class method (notice that it's 
not an MVC Controller or Web API Controller, just a plain C# class) from 
javascript like calling a javascript method? This is provided by ASP.NET 
Boilerplate. See
<a href="http://www.aspnetboilerplate.com/Pages/Documents/Dynamic-Web-API">
dynamic web api layer</a> documentation for more information. You can always 
call application services from console to debug or see returned JSON structure.</p>
<p>We can also check Audit Logs to see the request. Open <strong>AbpAuditLogs</strong> 
table in PhoneBook database to see the call information:</p>
<p>
<img class="img-thumbnail" alt="Audit Logs table" height="71" src="images/audit-log-table-getpeople.png" width="921" /></p>
<p>There are some other fields not shown here. So, we see that User with Id=2 
called GetPeople method of the PersonAppService in recorded time with the shown 
parameters and it' executed in 134 ms.</p>
<h3>Calling GetPeople Method From Angularjs Controller</h3>
<p>It's time to open phonebook Angularjs <strong>controller</strong> and get people to show on the 
view.</p>
<pre lang="js">(function() {
    appModule.controller(&#39;tenant.views.phonebook.index&#39;, [
        &#39;$scope&#39;, &#39;<strong>abp.services.app.person</strong>&#39;,
        function($scope, <strong>personService</strong>) {
            var vm = this;

            vm.persons = [];

<strong>            personService.getPeople({}).success(function(result) {
                vm.persons = result.items;
            });
</strong>        }
    ]);
})();</pre>
<p>We inject '<strong>abp.services.app.person</strong>' as <strong>personService</strong> 
parameter (See
<a href="http://www.aspnetboilerplate.com/Pages/Documents/Dynamic-Web-API">
dynamic web api layer</a> documentation to know how this service is 
automatically created). Then we call <strong>getPeople</strong> method and 
create a <strong>success</strong> handler to get <strong>result</strong> of the
<strong>AJAX</strong> request. That's all!</p>
<h3>Rendering People In Angular View</h3>
<p>We show people on the page is most basic form. See the changed view below:</p>
<pre lang="xml">&lt;div ng-controller=&quot;tenant.views.phonebook.index as vm&quot;&gt;
...            
            &lt;h3&gt;<strong>@L(&quot;AllPeople&quot;)</strong>&lt;/h3&gt;

            &lt;div class=&quot;list-group&quot;&gt;
                &lt;a href=&quot;javascript:;&quot; class=&quot;list-group-item&quot; <strong>ng-repeat=&quot;person in vm.persons&quot;</strong>&gt;
                    &lt;h4 class=&quot;list-group-item-heading&quot;&gt;
                        <strong>{{person.name}} {{person.surname}}
</strong>                    &lt;/h4&gt;
                    &lt;p class=&quot;list-group-item-text&quot;&gt;
                        <strong>{{person.emailAddress}}
</strong>                    &lt;/p&gt;
                &lt;/a&gt;
            &lt;/div&gt;
...
&lt;/div&gt;</pre>
<p>We used <strong>ng-repeat</strong> directive of Angularjs to render the array of 
people (vm.persons). See the result:</p>
<p>
<img class="img-thumbnail" alt="Phonebook peoples" height="285" src="images/phonebook-people-view-1.png" width="790" /></p>
<p>We successfully retrieved list of people from database to the page.</p>
<h3>Creating a new people</h3>
<p>Next step is to create a modal to add a new item to phone book.</p>
<h4>Add a CreatePerson Method to PersonAppService</h4>
<p>We first define <strong>CreatePerson</strong> method in <strong>IPersonAppService</strong> interface:</p>
<pre lang="cs">Task CreatePerson(CreatePersonInput input);</pre>
<p>Then we create <strong>CreatePersonInput</strong> DTO that defines parameters of the method:</p>
<pre lang="cs">[AutoMapTo(typeof(Person))]
public class CreatePersonInput : IInputDto
{
    [Required]
    [MaxLength(Person.MaxNameLength)]
    public string Name { get; set; }

    [Required]
    [MaxLength(Person.MaxSurnameLength)]
    public string Surname { get; set; }

    [EmailAddress]
    [MaxLength(Person.MaxEmailAddressLength)]
    public string EmailAddress { get; set; }
}</pre>
<p><strong>CreatePersonInput</strong> is mapped to <strong>Person</strong> 
entity (we will use mapping below). All properties are decorated by <strong>data 
annotation attributes</strong> to provide automatic <strong>
<a href="http://www.aspnetboilerplate.com/Pages/Documents/Validating-Data-Transfer-Objects">validation</a></strong>. 
Notice that we use same consts defined in Person entity for <strong>MaxLength</strong> 
properties.</p>
<p>Here, the implementation of CreatePerson method:</p>
<pre lang="cs">public async Task CreatePerson(CreatePersonInput input)
{
    var person = input.MapTo&lt;Person&gt;();
    await _personRepository.InsertAsync(person);
}</pre>
<p>A Person entity is created by mapping given input, then inserted to database. 
We used <strong>async/await</strong> pattern here. All methods in 
ASP.NET Zero startup project is <strong>async</strong>. It's adviced to use 
async/await wherever possible.</p>
<h4>Test CreatePerson Method</h4>
<p>You can skip this section if you don't interest in <strong>automated testing</strong>.</p>
<p>We can create a unit test method to test CreatePerson method as shown below:</p>
<pre lang="cs">[Fact]
public async Task Should_Create_Person_With_Valid_Arguments()
{
    //Act
    await _personAppService.CreatePerson(
        new CreatePersonInput
        {
            Name = &quot;John&quot;,
            Surname = &quot;Nash&quot;,
            EmailAddress = &quot;john.nash@abeautifulmind.com&quot;
        });

    //Assert
    UsingDbContext(
        context =&gt;
        {
            var john = context.Persons.FirstOrDefault(p =&gt; p.EmailAddress == &quot;john.nash@abeautifulmind.com&quot;);
            john.ShouldNotBe(null);
            john.Name.ShouldBe(&quot;John&quot;);
        });
}</pre>
<p>Test method also written using <strong>async/await</strong> pattern since 
calling method is async. We called CreatePerson method, then checked if given 
person is in the database. <strong>UsingDbContext</strong> method is a helper 
method of <strong>AppTestBase</strong> class (which we inherited this unit test 
class from). It's used to easily get a reference to DbContext and use it 
directly to perform database operations.</p>
<p>This method successfully works since all required fields are supplied. Let's 
try to create a test for <strong>invalid arguments</strong>:</p>
<pre lang="cs">[Fact]
public async Task Should_Not_Create_Person_With_Invalid_Arguments()
{
    //Act and Assert
    await Assert.ThrowsAsync&lt;AbpValidationException&gt;(
        async () =&gt;
                {
                    await _personAppService.CreatePerson(
                        new CreatePersonInput
                        {
                            Name = &quot;John&quot;
                        });
                });
}</pre>
<p>We did not set <strong>Surname</strong> property of CreatePersonInput despite 
of it's <strong>required</strong>. So, it throws <strong>AbpValidationException</strong> 
automatically. Also, we can not send null to CreatePerson method since 
validation system also checks it. This test calls CreatePerson with 
invalid arguments and asserts that it thows AbpValidationException. See
<a href="http://www.aspnetboilerplate.com/Pages/Documents/Validating-Data-Transfer-Objects">
validation document</a> for more information.</p>
<h4>Creating a Modal</h4>
<p>We will create a 
<a href="https://angular-ui.github.io/bootstrap/#/modal" target="_blank">Angular 
Bootstrap Ui-Modal</a> to create a new person as shown below:</p>
<p>
<img class="img-thumbnail" alt="Create Person Dialog" height="380" src="images/phonebook-create-person-dialog.png" width="620" /></p>
<p>View code is shown below:&nbsp;</p>
<pre lang="xml">@using Acme.PhoneBook.People
&lt;div&gt;
    &lt;form name=&quot;createPersonForm&quot; role=&quot;form&quot; novalidate class=&quot;form-validation&quot;&gt;
        &lt;div class=&quot;modal-header&quot;&gt;
            &lt;h4 class=&quot;modal-title&quot;&gt;
                &lt;span&gt;@L(&quot;CreateNewPerson&quot;)&lt;/span&gt;
            &lt;/h4&gt;
        &lt;/div&gt;
        &lt;div class=&quot;modal-body&quot;&gt;
            
            &lt;div class=&quot;form-group form-md-line-input form-md-floating-label no-hint&quot;&gt;
                &lt;input class=&quot;form-control&quot; type=&quot;text&quot; name=&quot;Name&quot; <strong>ng-model=&quot;vm.person.name&quot;</strong> required maxlength=&quot;@Person.MaxNameLength&quot;&gt;
                &lt;label&gt;@L(&quot;Name&quot;)&lt;/label&gt;
            &lt;/div&gt;

            &lt;div class=&quot;form-group form-md-line-input form-md-floating-label no-hint&quot;&gt;
                &lt;input type=&quot;text&quot; name=&quot;Surname&quot; class=&quot;form-control&quot; <strong>ng-model=&quot;vm.person.surname&quot;</strong> required maxlength=&quot;@Person.MaxSurnameLength&quot;&gt;
                &lt;label&gt;@L(&quot;Surname&quot;)&lt;/label&gt;
            &lt;/div&gt;
            
            &lt;div class=&quot;form-group form-md-line-input form-md-floating-label no-hint&quot;&gt;
                &lt;input type=&quot;email&quot; name=&quot;EmailAddress&quot; class=&quot;form-control&quot; <strong>ng-model=&quot;vm.person.emailAddress&quot;</strong> maxlength=&quot;@Person.MaxEmailAddressLength&quot;&gt;
                &lt;label&gt;@L(&quot;EmailAddress&quot;)&lt;/label&gt;
            &lt;/div&gt;

        &lt;/div&gt;
        &lt;div class=&quot;modal-footer&quot;&gt;
            &lt;button ng-disabled=&quot;vm.saving&quot; type=&quot;button&quot; class=&quot;btn btn-default&quot; <strong>ng-click=&quot;vm.cancel()&quot;</strong>&gt;@L(&quot;Cancel&quot;)&lt;/button&gt;
            &lt;button type=&quot;submit&quot; <strong>button-busy=&quot;vm.saving&quot;</strong> busy-text=&quot;@L(&quot;SavingWithThreeDot&quot;)&quot; class=&quot;btn btn-primary blue&quot; <strong>ng-click=&quot;vm.save()&quot; ng-disabled=&quot;createPersonForm.$invalid&quot;</strong>&gt;&lt;i class=&quot;fa fa-save&quot;&gt;&lt;/i&gt; &lt;span&gt;@L(&quot;Save&quot;)&lt;/span&gt;&lt;/button&gt;
        &lt;/div&gt;
    &lt;/form&gt;
&lt;/div&gt;</pre>
<p>We have a form with three input (name, surname and email address) <strong>
validated</strong> using Angularjs. We're using <strong>Person</strong> entity's 
const values in view to set same <strong>maxlength</strong> to input controls.</p>
<p><strong>Save</strong> button is <strong>disabled</strong> if the form is
<strong>invalid</strong>. <strong>button-busy</strong> directive makes buttons 
disable and animates it while submitting form:</p>
<p>
<img class="img-thumbnail" alt="Modal button busy animation" height="59" src="images/modal-buttons-busy.png" width="208" /></p>
<p>Angularjs <strong>controller</strong> of this view is shown below:</p>
<pre lang="cs">(function () {
    appModule.controller(&#39;tenant.views.phonebook.createPersonModal&#39;, [
        &#39;$scope&#39;, &#39;$uibModalInstance&#39;, &#39;abp.services.app.person&#39;,
        function ($scope, $uibModalInstance, personService) {
            var vm = this;
            
            vm.saving = false;
            vm.person = {};

            vm.save = function () {
                vm.saving = true;
<strong>                personService.createPerson(vm.person).success(function () {
                    abp.notify.info(app.localize(&#39;SavedSuccessfully&#39;));
                    $uibModalInstance.close();
                }).finally(function () {
                    vm.saving = false;
                });
</strong>            };

            vm.cancel = function () {
                $uibModalInstance.dismiss();
            };
        }
    ]);
})();</pre>
<p>Controller is simple. It calls <strong>createPerson</strong> method of
<strong>PersonAppService</strong> when we click the <strong>Save</strong> 
button. <strong>vm.saving</strong> flag is <strong>true</strong> 
during AJAX operation. This value is used on view to disable and make buttons 
animated. If createPerson success, modal is <strong>closed</strong>.</p>
<h4>Opening the Modal</h4>
<p>We return to phone book view and add a <strong>button</strong> to open this modal:</p>
<pre lang="xml">&lt;button class=&quot;btn btn-primary blue&quot; <strong>ng-click=&quot;vm.openCreatePersonModal()&quot;</strong>&gt;&lt;i class=&quot;fa fa-plus&quot;&gt;&lt;/i&gt; @L(&quot;CreateNewPerson&quot;)&lt;/button&gt;</pre>
<p><strong>vm.openCreatePersonModal</strong> method is called when we click this button:</p>
<pre lang="js">(function() {
    appModule.controller(&#39;tenant.views.phonebook.index&#39;, [
        &#39;$scope&#39;, &#39;<strong>$uibModal</strong>&#39;, &#39;abp.services.app.person&#39;,
        function ($scope, <strong>$uibModal</strong>, personService) {
            var vm = this;

            vm.persons = [];

            function getPeople() {
                personService.getPeople({}).success(function (result) {
                    vm.persons = result.items;
                });
            }
            
<strong>            vm.openCreatePersonModal = function () {
                var modalInstance = $uibModal.open({
                    templateUrl: &#39;~/App/tenant/views/phonebook/createPersonModal.cshtml&#39;,
                    controller: &#39;tenant.views.phonebook.createPersonModal as vm&#39;,
                    backdrop: &#39;static&#39;
                });

                modalInstance.result.then(function () {
                    getPeople();
                });
            };</strong>

            getPeople();
        }
    ]);
})();</pre>
<p>We open modal using $uibModal service by providing view and controller. We 
re-load person list (by calling getPeople function) after modal closed.</p>
<h3>Authorization For Phone Book</h3>
<p>At this point, anyone can enter phone book page since no authorization 
defined. We will define two permission:</p>
<ul>
	<li>A permission to <strong>enter phone book page</strong>.</li>
	<li>A permission to <strong>create new person</strong> (which is a child 
	permission of first one, as naturally).</li>
</ul>
<h4>Permission for Entering Phone Book Page</h4>
<h5>Define the permission</h5>
<p>Go to <strong>AppAuthorizationProvider</strong> class and add a new permission as shown below:</p>
<pre lang="cs">pages.CreateChildPermission(AppPermissions.Pages_Tenant_PhoneBook, L(&quot;PhoneBook&quot;), multiTenancySides: MultiTenancySides.Tenant);</pre>
<p>A permission should have a unique name. We define permission names as 
constant strings in <strong>AppPermissions</strong> class. It's a simple constant string:</p>
<pre lang="cs">public const string Pages_Tenant_PhoneBook = &quot;<strong>Pages.Tenant.PhoneBook</strong>&quot;;</pre>
<p>Unique name of this permission is "<strong>Pages.Tenant.PhoneBook</strong>". 
While you can set any string (as long as it's unique), it's suggested this 
convention. A permission can have a localizable display name: "<strong>PhoneBook</strong>" 
here. (see "Adding a New Page" section for more about localization, since it's 
very similar). Lastly, we set that this is a <strong>tenant</strong> level 
permission.</p>
<h5>Add AbpAuthorize attribute</h5>
<p><strong>AbpAuthorize</strong> attribute can be used as <strong>class level</strong> 
or <strong>method level</strong> to protect an application service or service method from 
unauthorized users. Since all server side code is located in PersonAppService 
class, we can declare a class level attribute as shown below:</p>
<pre lang="cs"><strong>[AbpAuthorize(AppPermissions.Pages_Tenant_PhoneBook)]
</strong>public class PersonAppService : PhoneBookAppServiceBase, IPersonAppService
{
    //...
}</pre>
<p>Now, let's try to enter Phone Book page by clicking the menu item:</p>
<p>
<img class="img-thumbnail" alt="Permission (Authorization) Error" height="461" src="images/permission-error.png" width="971" /></p>
<p>We get an error message. This exception is thrown when any method of 
PersonAppService is called without needed permission.</p>
<h5>Hide Unauthorized Menu Item</h5>
<p>This secures the service, but we should also <strong>hide</strong> the Phone book 
<strong>menu item</strong>. It's 
easy, open AppNavigationProvider and add requiredPermissionName as shown below:</p>
<pre lang="cs">new MenuItemDefinition(
    PageNames.App.Tenant.PhoneBook,
    L(&quot;PhoneBook&quot;),
    url: &quot;tenant.phonebook&quot;,
    icon: &quot;glyphicon glyphicon-book&quot;,
    <strong>requiredPermissionName: AppPermissions.Pages_Tenant_PhoneBook
</strong>)</pre>
<h5>Disable Angular Route</h5>
<p>While hiding menu item prevents user to enter the page by clicking it, he can 
still enter the page by entering the following URL directly to address bar of browsers:</p>
<pre>http://localhost:6234/Application#/tenant/phonebook</pre>
<p>We should also conditionally define angular routes. Thus, if user has no 
permission to enter this page, he can not activate the route:</p>
<pre lang="js">if (abp.auth.hasPermission(&#39;Pages.Tenant.PhoneBook&#39;)) {
    $stateProvider.state(&#39;tenant.phonebook&#39;, {
        url: &#39;/phonebook&#39;,
        templateUrl: &#39;~/App/tenant/views/phonebook/index.cshtml&#39;,
        menu: &#39;PhoneBook&#39;
    });
}</pre>
<p>We wrapper route definition by an if block that checks related permission. 
Now, user can not open the page without the permission. He is redirected to 
default route by Angularjs.</p>
<h5>Grant permission</h5>
<p>So, how we can enter the page now? Simple, go to <strong>Role Management</strong> 
page and edit <strong>admin</strong> role:</p>
<p>
<img class="img-thumbnail" alt="Role permissions" height="574" src="images/role-permissions-with-phonebook.png" width="617" /></p>
<p>We see that a <strong>new permission</strong> named "<strong>Phone book</strong>" 
added to <strong>permissions</strong> tab. So, we can check it and save the 
role. After saving, we need to <strong>refresh </strong>the whole page to 
refresh permissions for the current user. We could also grant this permission 
for a specific user (see <a href="Development-Guide.html">development guide 
document</a> for details about roles and users).</p>
<p>Now, we can enter the Phone book page again.</p>
<h4>Permission for Create New Person</h4>
<p>While a permission for a page is useful and probably needed always, we may 
need to define additional permissions to perform some <strong>specific actions</strong> 
on a page, like creating a new person. </p>
<h5>Define the permission</h5>
<p>Defining a permission is similar:</p>
<pre lang="cs">var phoneBook = pages.CreateChildPermission(AppPermissions.Pages_Tenant_PhoneBook, L(&quot;PhoneBook&quot;), multiTenancySides: MultiTenancySides.Tenant);
<strong>phoneBook.CreateChildPermission(AppPermissions.Pages_Tenant_PhoneBook_CreatePerson, L(&quot;CreateNewPerson&quot;), multiTenancySides: MultiTenancySides.Tenant);</strong></pre>
<p>First permission was defined before. In the second line, we are creating a 
child permission of first one.</p>
<h5>Add AbpAuthorize attribute</h5>
<p>This time, we're declaring <strong>AbpAuthorize</strong> attribute just for 
<strong>CreatePerson</strong> 
method:</p>
<pre lang="cs"><strong>[AbpAuthorize(AppPermissions.Pages_Tenant_PhoneBook_CreatePerson)]
</strong>public async Task CreatePerson(CreatePersonInput input)
{
    //...
}
</pre>
<h5>Hide Unauthorized Button</h5>
<p>If we run the application and try to create a person, we get an authorization 
error after clicking the save button. But, it's good to <strong>completely hide 
Create New Person button</strong> if we don't have the permission. There are a 
few ways of doing it.</p>
<p>We can implement it in <strong>index.cshtml</strong> razor view on <strong>server side</strong> using
<strong>IsGranted</strong> 
method:</p>
<pre lang="xml">@if (IsGranted(AppPermissions.Pages_Tenant_PhoneBook_CreatePerson))
{
    &lt;button class=&quot;btn btn-primary blue&quot; ng-click=&quot;vm.openCreatePersonModal()&quot;&gt;&lt;i class=&quot;fa fa-plus&quot;&gt;&lt;/i&gt; @L(&quot;CreateNewPerson&quot;)&lt;/button&gt;
}</pre>
<p>In this way, the Create New Person does not rendered in server and user can 
not see this button.</p>
<p>As an alternative, we can check permission on <strong>client side</strong>. 
First, we declare a variable in Angularjs controller:</p>
<pre lang="js">vm.permissions = {
    createPerson: abp.auth.hasPermission(&#39;Pages.Tenant.PhoneBook.CreatePerson&#39;)
};</pre>
<p>And then use it in a <strong>ng-if</strong> directive in view to conditionally render the button:</p>
<pre lang="xml">&lt;button <strong>ng-if=&quot;vm.permissions.createPerson&quot;</strong> class=&quot;btn btn-primary blue&quot; ng-click=&quot;vm.openCreatePersonModal()&quot;&gt;&lt;i class=&quot;fa fa-plus&quot;&gt;&lt;/i&gt; @L(&quot;CreateNewPerson&quot;)&lt;/button&gt;</pre>
<h5>Grant permission</h5>
<p>To see the button again, we can go to role or user manager and grant related 
permission as shown below:</p>
<p>
<img class="img-thumbnail" alt="User specific permissions" height="527" src="images/user-permissions-phonebook.png" width="617" /></p>
<p>As shown above, <strong>Create new person</strong> permission is a child 
permission of the <strong>Phone book</strong>.</p>
<p>See <a href="http://www.aspnetboilerplate.com/Pages/Documents/Authorization">
authorization documentation</a> for more information on authorization.</p>
<h3>Deleting a Person</h3>
<p>Let's add a delete button in people list as shown below:</p>
<p>
<img class="img-thumbnail" alt="Delete person" height="409" src="images/phonebook-people-delete-button.png" width="768" /></p>
<p>
We're starting from UI in this case.</p>
<h4>View</h4>
<p>We're changing index.cshtml view to add a button (related part is shown 
here):</p>
<pre lang="xml">&lt;div id=&quot;AllPeopleList&quot; class=&quot;list-group&quot;&gt;
    &lt;a href=&quot;javascript:;&quot; class=&quot;list-group-item&quot; ng-repeat=&quot;person in vm.persons&quot;&gt;
        &lt;h4 class=&quot;list-group-item-heading&quot;&gt;
            {{person.name}} {{person.surname}}
<strong>            &lt;button ng-if="vm.permissions.deletePerson" ng-click=&quot;vm.deletePerson(person)&quot; title=&quot;@L(&quot;Delete&quot;)&quot; class=&quot;btn btn-circle btn-icon-only red delete-person&quot; href=&quot;javascript:;&quot;&gt;
                &lt;i class=&quot;icon-trash&quot;&gt;&lt;/i&gt;
            &lt;/button&gt;
</strong>        &lt;/h4&gt;
        &lt;p class=&quot;list-group-item-text&quot;&gt;
            {{person.emailAddress}}
        &lt;/p&gt;
    &lt;/a&gt;
&lt;/div&gt;</pre>
<p>Surely, we defined 'delete person' permission as like before.</p>
<h4>Style</h4>
<p>We're using a <strong><a href="http://lesscss.org/" target="_blank">LESS</a></strong> style here to take button right. Created 
a file named index.less and added following lines:</p>
<pre lang="css">#AllPeopleList {
    .list-group-item-heading {
        button.delete-person {
            float: right;
        }
    }
}
</pre>
<p>Pre-built bundling configuration automatically includes styles to layout.</p>
<h4>Controller</h4>
<p>Now, creating a <strong>deletePerson</strong> function in Angularjs controller (that was called from 
view above):</p>
<pre lang="js">vm.deletePerson = function (person) {
    abp.message.confirm(
        app.localize(&#39;AreYouSureToDeletePerson&#39;, person.name),
        function (isConfirmed) {
            if (isConfirmed) {
                personService.deletePerson({
                    id: person.id
                }).success(function () {
                    abp.notify.success(app.localize(&#39;SuccessfullyDeleted&#39;));
                    getPeople();
                });
            }
        }
    );
};</pre>
<p>It first shows a confirmation message when we click the delete button:</p>
<p>
<img class="img-thumbnail" alt="Confirmation message" height="338" src="images/confirmation-delete-person.png" width="493" /></p>
<p>If we click Yes, it simply calls <strong>deletePerson</strong> method of 
<strong>PersonAppService</strong> and shows a 
notification if operation succeed.</p>
<p>Localization string "<strong>AreYouSureToDeletePerson</strong>" was defined 
like that:</p>
<pre lang="xml">&lt;text name=&quot;AreYouSureToDeletePerson&quot; value=&quot;Are you sure to delete person named {0}?&quot; /&gt;</pre>
<p>So, we can pass a name into localize method. This is similar to C#'s 
string.Format method.</p>
<h4>Application Service</h4>
<p>First, adding a new method definition to <strong>IPersonAppService</strong> interface as always:</p>
<pre lang="cs">Task DeletePerson(IdInput input);</pre>
<p><strong>IdInput</strong> is a shortcut of ABP if we only get an id value. Implementation (in 
<strong>PersonAppService</strong>) is very simple:</p>
<pre lang="cs">[AbpAuthorize(AppPermissions.Pages_Tenant_PhoneBook_DeletePerson)]
public async Task DeletePerson(IdInput input)
{
    await _personRepository.DeleteAsync(input.Id);
}</pre>
<p>We also <strong>authorized</strong> deleting a person as did before for creating a person.</p>
<h3>Filtering people</h3>
<p>Now, we will implement <strong>search</strong> functionality of <strong>
GetPeople</strong> method. UI is shown below:</p>
<p>
<img class="img-thumbnail" alt="Searching people" height="328" src="images/search-people.png" width="770" /></p>
<p>We added a search input to filter people:</p>
<pre lang="xml">&lt;input <strong>ng-model=&quot;vm.filterText&quot; auto-focus</strong> class=&quot;form-control&quot; placeholder=&quot;@L(&quot;SearchWithThreeDot&quot;)&quot; type=&quot;text&quot;&gt;
&lt;span class=&quot;input-group-btn&quot;&gt;
    &lt;button <strong>ng-click=&quot;vm.getPeople()&quot;</strong> class=&quot;btn btn-default&quot; type=&quot;submit&quot;&gt;&lt;i class=&quot;icon-magnifier&quot;&gt;&lt;/i&gt;&lt;/button&gt;
&lt;/span&gt;</pre>
<p>and changed title to show people count:</p>
<pre lang="xml">&lt;h3&gt;@L(&quot;AllPeople&quot;) (<strong>{{vm.persons.length}}</strong>)&lt;/h3&gt;</pre>
<p>Lastly, changed <strong>getPeople</strong> function in controller, to send 
<strong>vm.filterText</strong> to server:</p>
<pre lang="js">vm.getPeople = function() {
    personService.getPeople({
<strong>        filter: vm.filterText
</strong>    }).success(function (result) {
        vm.persons = result.items;
    });
};</pre>
<p>That's all. It works since we already have implemented filtering on server.</p>
<h3>Extending the Application: Adding Phone Numbers</h3>
<p>Until now, we did not even mention about phone numbers. It's time to extend 
our domain to support <strong>multiple phone numbers</strong> for a person.</p>
<h3>Creating Phone Entity</h3>
<p>Let's start by creating a new Entity, <strong>Phone</strong> in <strong>.Core</strong> 
project:</p>
<pre lang="cs">[Table(&quot;PbPhones&quot;)]
public class Phone : CreationAuditedEntity&lt;long&gt;
{
    public const int MaxNumberLength = 16;

    [ForeignKey(&quot;PersonId&quot;)]
    public virtual Person Person { get; set; }
    public virtual int PersonId { get; set; }

    [Required]
    public virtual PhoneType Type { get; set; }

    [Required]
    [MaxLength(MaxNumberLength)]
    public virtual string Number { get; set; }
}</pre>
<p>Phone entities are stored in <strong>PbPhones</strong> table. It's primary key is <strong>long</strong> 
and inherits creation auditing properties. It has a reference to <strong>Person</strong> entity which owns the phone 
number.</p>
<p>We added a <strong>Phones</strong> collection to the People:</p>
<pre lang="cs">[Table(&quot;PbPersons&quot;)]
public class Person : FullAuditedEntity
{
    //...other properties

    <strong>public virtual ICollection&lt;Phone&gt; Phones { get; set; }</strong>
}</pre>
<p>We have a <strong>PhoneType</strong> enum as shown below:</p>
<pre lang="cs">public enum PhoneType : byte
{
    Mobile,
    Home,
    Business
}</pre>
<p>Lastly, we're also adding a DbSet property for Phone to our DbContext:</p>
<pre lang="cs">public virtual IDbSet&lt;Phone&gt; Phones { get; set; }</pre>
<h3>Adding Database Migration</h3>
<p>Our entity model has changed, so we need to add a new migration:</p>
<p>
<img class="img-thumbnail" alt="Entity Framework Migration" height="81" src="images/phonebook-migrations-2.png" width="598" /></p>
<p>This will create a new code based migration file to create <strong>PbPhones</strong> 
table:</p>
<pre lang="cs">public partial class Added_Phone : DbMigration
{
    public override void Up()
    {
        CreateTable(
            &quot;dbo.PbPhones&quot;,
            c =&gt; new
                {
                    Id = c.Long(nullable: false, identity: true),
                    PersonId = c.Int(nullable: false),
                    Type = c.Byte(nullable: false),
                    Number = c.String(nullable: false, maxLength: 16),
                    CreationTime = c.DateTime(nullable: false),
                    CreatorUserId = c.Long(),
                })
            .PrimaryKey(t =&gt; t.Id)
            .ForeignKey(&quot;dbo.PbPersons&quot;, t =&gt; t.PersonId, cascadeDelete: true)
            .Index(t =&gt; t.PersonId);
            
    }
        
    public override void Down()
    {
        DropForeignKey(&quot;dbo.PbPhones&quot;, &quot;PersonId&quot;, &quot;dbo.PbPersons&quot;);
        DropIndex(&quot;dbo.PbPhones&quot;, new[] { &quot;PersonId&quot; });
        DropTable(&quot;dbo.PbPhones&quot;);
    }
}</pre>
<p>Before updating database, we can go to database <strong>seed</strong> code 
and add example <strong>phone numbers</strong> for example people:</p>
<pre lang="cs">public class InitialPeopleAndPhoneCreator
{
    //...

    public void Create()
    {
        var douglas = _context.Persons.FirstOrDefault(p =&gt; p.EmailAddress == &quot;douglas.adams@fortytwo.net&quot;);
        if (douglas == null)
        {
            _context.Persons.Add(
                new Person
                {
                    Name = &quot;Douglas&quot;,
                    Surname = &quot;Adams&quot;,
                    EmailAddress = &quot;douglas.adams@fortytwo.com&quot;,
<strong>                    Phones = new List&lt;Phone&gt;
                                {
                                    new Phone {Type = PhoneType.Home, Number = &quot;1112242&quot;},
                                    new Phone {Type = PhoneType.Mobile, Number = &quot;2223342&quot;}
                                }
</strong>                });
        }

        var asimov = _context.Persons.FirstOrDefault(p =&gt; p.EmailAddress == &quot;isaac.asimov@foundation.org&quot;);
        if (asimov == null)
        {
            _context.Persons.Add(
                new Person
                {
                    Name = &quot;Isaac&quot;,
                    Surname = &quot;Asimov&quot;,
                    EmailAddress = &quot;isaac.asimov@foundation.org&quot;,
<strong>                    Phones = new List&lt;Phone&gt;
                                {
                                    new Phone {Type = PhoneType.Home, Number = &quot;8889977&quot;}
                                }
</strong>                });
        }
    }
}</pre>
<p>We added two phone number to Douglas, one phone number to Isaac. But if we 
run Update-Database now, phones are not inserted since this seed code checks if 
people exists, and does not insert if it's already exists. What's solution? 
Since we haven't deployed yet, we can delete database (or at lease truncate 
people table) and re-create it. I do it.</p>
<p>Now, we are running <strong>Update-Database</strong> command in Package 
Manager Console to re-create database and seed it. You can check database to see
<strong>PbPhones</strong> table and rows.</p>
<h3>Changing GetPeople Method</h3>
<p>We're changing <strong>PersonAppService.GetPeople</strong> method to <strong>
include</strong> phone numbers of people into return value.</p>
<p>First, we're 
changing <strong>PersonListDto</strong> to contain a list of phones:</p>
<pre lang="cs">[AutoMapFrom(typeof(Person))]
public class PersonListDto : FullAuditedEntityDto
{
    public string Name { get; set; }

    public string Surname { get; set; }

    public string EmailAddress { get; set; }

<strong>    public Collection&lt;PhoneInPersonListDto&gt; Phones { get; set; }
</strong>}

<strong>[AutoMapFrom(typeof(Phone))]
public class PhoneInPersonListDto : CreationAuditedEntityDto&lt;long&gt;
</strong>{<strong>
    public PhoneType Type { get; set; }

    public string Number { get; set; }
</strong>}</pre>
<p>So, added also a DTO to transfer phone numbers and mapped from Phone entity. Now, we can change GetPeople method to get Phones from database:</p>
<pre lang="cs">public ListResultOutput&lt;PersonListDto&gt; GetPeople(GetPeopleInput input)
{
    var persons = _personRepository
        .GetAll()
<strong>        .Include(p =&gt; p.Phones)
</strong>        .WhereIf(
            !input.Filter.IsNullOrEmpty(),
            p =&gt; p.Name.Contains(input.Filter) ||
                    p.Surname.Contains(input.Filter) ||
                    p.EmailAddress.Contains(input.Filter)
        )
        .OrderBy(p =&gt; p.Name)
        .ThenBy(p =&gt; p.Surname)
        .ToList();

    return new ListResultOutput&lt;PersonListDto&gt;(persons.MapTo&lt;List&lt;PersonListDto&gt;&gt;());
}</pre>
<p>We only added <strong>Include</strong> extension method to the query. Rest of 
the codes remains same. Furthermore, it would work without adding this, but much 
slower (since it will lazy load phone numbers for every person seperately).</p>
<h3>AddPhone and DeletePhone Methods</h3>
<p>We are adding two more methods to IPersonAppService interface as shown below:</p>
<pre lang="cs">Task DeletePhone(IdInput&lt;long&gt; input);
Task&lt;PhoneInPersonListDto&gt; AddPhone(AddPhoneInput input);</pre>
<p>We could create a new, seperated IPhoneAppService. It's your choice. But, we 
can consider Person as an aggregate and add phone related methods here. AddPhoneInput 
DTO is shown below:</p>
<pre lang="cs">[AutoMapTo(typeof(Phone))]
public class AddPhoneInput : IInputDto
{
    [Range(1, int.MaxValue)]
    public int PersonId { get; set; }

    [Required]
    public PhoneType Type { get; set; }

    [Required]
    [MaxLength(Phone.MaxNumberLength)]
    public string Number { get; set; }
}</pre>
<p>Now, we can implement these methods:</p>
<pre lang="cs">public async Task DeletePhone(IdInput&lt;long&gt; input)
{
    await _phoneRepository.DeleteAsync(input.Id);
}

public async Task&lt;PhoneInPersonListDto&gt; AddPhone(AddPhoneInput input)
{
    var person = _personRepository.Get(input.PersonId);

    var phone = input.MapTo&lt;Phone&gt;();
    person.Phones.Add(phone);
            
    await CurrentUnitOfWork.SaveChangesAsync();

    return phone.MapTo&lt;PhoneInPersonListDto&gt;();
}</pre>
<p><strong>DeletePhone</strong> method is simple. It only deletes phone with 
given id.</p>
<p><strong>AddPhone</strong> method <strong>gets </strong>the person from 
database and add new phone to person.Phones collection. Then is <strong>save 
changes</strong>. Saving changes causes inserting new added phone to database 
and get it's <strong>Id</strong>. Because, we are returning a DTO that contains 
newly created phone informations including Id. So, it should be assigned before 
mapping in the last line. (Notice that; normally it's not needed to call 
CurrentUnitOfWork.SaveChangesAsync. It's automatically called at the end of the 
method. We called it in the method since we need to save entity and get it's Id 
immediately. See
<a href="http://www.aspnetboilerplate.com/Pages/Documents/Unit-Of-Work#DocAutoSaveChanges">
UOW document</a> for more.)</p>
<p>There may be different approaches for AddPhone method. You can directly work 
with a <strong>phone repository</strong> to insert new phone. They all have 
different pros and cons. It's your choice.</p>
<h3>Edit Mode For People List</h3>
<p>Final UI is shown below:</p>
<p>
<img class="img-thumbnail" alt="Phone book edit mode" height="642" src="images/phone-book-edit-mode.png" width="762" /></p>
<p>When we click the <strong>green edit icon</strong> for a person, it's row is 
expanded and all phone numbers are shown. Then we can delete any number by 
clicking the icon at left. We can add a new phone from the inputs at last line.</p>
<h4>View</h4>
<p>Changes in view are shown below:</p>
<pre lang="xml">&lt;div id=&quot;AllPeopleList&quot; class=&quot;list-group&quot;&gt;
    &lt;div class=&quot;list-group-item&quot; ng-repeat=&quot;person in vm.persons&quot; ng-class=&quot;{&#39;person-editing&#39;:person==vm.editingPerson}&quot;&gt;
        &lt;h4 class=&quot;list-group-item-heading&quot;&gt;
            {{person.name}} {{person.surname}}
            &lt;span class=&quot;person-buttons&quot;&gt;
<strong>                &lt;button ng-click=&quot;vm.editPerson(person)&quot; title=&quot;@L(&quot;Edit&quot;)&quot; class=&quot;btn btn-circle btn-icon-only green&quot;&gt;
                    &lt;i class=&quot;icon-pencil&quot;&gt;&lt;/i&gt;
                &lt;/button&gt;
</strong>                &lt;button ng-if=&quot;vm.permissions.deletePerson&quot; ng-click=&quot;vm.deletePerson(person)&quot; title=&quot;@L(&quot;Delete&quot;)&quot; class=&quot;btn btn-circle btn-icon-only red&quot;&gt;
                    &lt;i class=&quot;icon-trash&quot;&gt;&lt;/i&gt;
                &lt;/button&gt;
            &lt;/span&gt;
        &lt;/h4&gt;
        &lt;p class=&quot;list-group-item-text&quot;&gt;
            {{person.emailAddress}}
        &lt;/p&gt;
<strong>        &lt;div class=&quot;table-scrollable&quot; ng-if=&quot;person==vm.editingPerson&quot;&gt;
            &lt;table class=&quot;table table-hover&quot;&gt;
                &lt;thead&gt;
                    &lt;tr&gt;
                        &lt;th style=&quot;width:10%&quot;&gt;&lt;/th&gt;
                        &lt;th style=&quot;width:15%&quot;&gt;@L(&quot;Type&quot;)&lt;/th&gt;
                        &lt;th style=&quot;width:75%&quot;&gt;@L(&quot;PhoneNumber&quot;)&lt;/th&gt;
                    &lt;/tr&gt;
                &lt;/thead&gt;
                &lt;tbody&gt;
                    &lt;tr ng-repeat=&quot;phone in person.phones&quot;&gt;
                        &lt;td&gt;
                            &lt;button ng-click=&quot;vm.deletePhone(phone, person)&quot; class=&quot;btn btn-sm btn-default&quot;&gt;
                                &lt;i class=&quot;icon-trash&quot;&gt;&lt;/i&gt;
                            &lt;/button&gt;
                        &lt;/td&gt;
                        &lt;td&gt;{{vm.getPhoneTypeAsString(phone.type)}}&lt;/td&gt;
                        &lt;td&gt;{{phone.number}}&lt;/td&gt;
                    &lt;/tr&gt;
                    &lt;tr&gt;
                        &lt;td&gt;
                            &lt;button ng-click=&quot;vm.addPhone(person.newPhone, person)&quot; class=&quot;btn btn-sm green&quot;&gt;
                                &lt;i class=&quot;fa fa-floppy-o&quot;&gt;&lt;/i&gt;
                            &lt;/button&gt;
                        &lt;/td&gt;
                        &lt;td&gt;
                            &lt;select name=&quot;Type&quot; ng-model=&quot;person.newPhone.type&quot;&gt;
                                &lt;option value=&quot;0&quot;&gt;@L(&quot;PhoneType_Mobile&quot;)&lt;/option&gt;
                                &lt;option value=&quot;1&quot;&gt;@L(&quot;PhoneType_Home&quot;)&lt;/option&gt;
                                &lt;option value=&quot;2&quot;&gt;@L(&quot;PhoneType_Business&quot;)&lt;/option&gt;
                            &lt;/select&gt;
                        &lt;/td&gt;
                        &lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;Number&quot; ng-model=&quot;person.newPhone.number&quot; /&gt;&lt;/td&gt;
                    &lt;/tr&gt;
                &lt;/tbody&gt;
            &lt;/table&gt;
        &lt;/div&gt;
</strong>    &lt;/div&gt;
&lt;/div&gt;</pre>
<p>We added an edit button for each person. Then added a table (shown if this 
person is being edited) for each person that shows phones of the related person 
and allows adding a new phone.</p>
<h4>Controller</h4>

<p>Added following codes into the Angularjs controller:</p>
<pre lang="js">vm.editingPerson = null;

vm.editPerson = function(person) {
    if (person == vm.editingPerson) {
        vm.editingPerson = null;
    } else {
        vm.editingPerson = person;
    }
};

vm.getPhoneTypeAsString = function(typeAsNumber) {
    switch (typeAsNumber) {
    case 0:
        return app.localize(&#39;PhoneType_Mobile&#39;);
    case 1:
        return app.localize(&#39;PhoneType_Home&#39;);
    case 2:
        return app.localize(&#39;PhoneType_Business&#39;);
    default:
        return &#39;?&#39;;
    }
};

vm.deletePhone = function(phone, person) {
    personService.deletePhone({
        id: phone.id
    }).success(function() {
        abp.notify.success(app.localize(&#39;SuccessfullyDeleted&#39;));
        person.phones = _.without(person.phones, phone);
    });
};

vm.addPhone = function(phone, person) {
    if (!phone || !phone.type || !phone.number) {
        abp.message.warn(&#39;Please select a phone type and enter a number!&#39;);
        return;
    }

    phone.personId = person.id;

    personService.addPhone(phone)
        .success(function(result) {
            abp.notify.success(app.localize(&#39;SavedSuccessfully&#39;));
            person.phones.push(result);
            phone.number = &#39;&#39;;
        });
};</pre>
<h3>Multi Tenancy</h3>
<p>We have built a fully functional application until here. Now, we will see how 
to convert it to a multi-tenant application easily.</p>
<h4>Enable Multi Tenancy</h4>
<p>We disabled multi-tenancy at the begginning of this document. Now, re-enabling it in <strong>PhoneBookCoreModule</strong> class:</p>
<pre lang="cs">Configuration.MultiTenancy.IsEnabled = true;</pre>
<h4>Make Entities Multi Tenant</h4>
<p>In a multi-tenant application, a tenant's entities should be isolated by 
other tenants. For this example project, every tenant should have own phone book 
with isolated people and phone numbers.</p>
<p>When we implement IMustHaveTenant interface, ABP automatically
<a href="http://www.aspnetboilerplate.com/Pages/Documents/Data-Filters">filters 
data</a> based on current Tenant, while retrieving entities from database. So, we should declare that Person entity 
must have a tenant using <strong>IMustHaveTenant</strong> interface:</p>
<pre lang="cs">public class Person : FullAuditedEntity, <strong>IMustHaveTenant</strong>
{
    <strong>public virtual int TenantId { get; set; }
</strong>
    //...other properties
}</pre>
<p>We may want to add IMustHaveTenant interface to also Phone entity. This is 
needed if we directly use phone repository to get phones. In this sample 
project, it's not needed.</p>
<p>Since entities have changed, we should create a new database migration:</p>
<pre>Add-Migration "Implemented_IMustHaveTenant_For_Person"</pre>
<p>This command creates a new code-first database migration. The migration class 
adds an annotation this is needed for automatic filtering. We don't have to know 
what it is since it's done automatically. And also it adds a TenantId column to 
PbPersons table as shown below:</p>
<pre lang="cs">AddColumn(&quot;dbo.PbPersons&quot;, &quot;TenantId&quot;, c =&gt; c.Int(nullable: false, <strong>defaultValue: 1</strong>));</pre>
<p>I added <strong>defaultValue as 1</strong> to AddColumn options. Thus, 
current People are automatically assigned to <strong>default tenant</strong> 
(default tenant's id is 1).</p>
<p>Now, we can update the database again:</p>
<pre>Update-Database</pre>
<h4>Run The Multi Tenant Application</h4>
<p><strong>It's finished</strong>! We can test the application. Run the project, <strong>login</strong> as 
<strong>host</strong> 
as shown blow:</p>
<p>
<img class="img-thumbnail" alt="Login as host" height="400" src="images/login-as-host.png" width="419" /></p>
<p>Since we enabled multi-tenancy, we see a <strong>Tenancy name </strong>input 
on login form. When we leave it <strong>empty</strong>, we login as a <strong>host user</strong>. 
Default <strong>admin</strong> password is <strong>123qwe</strong>.</p>
<p>After login, we see the <strong>tenant list</strong> which only contains a <strong>default</strong> 
tenant. We can create a new tenant:</p>
<p>
<img class="img-thumbnail" alt="Creating tenant" height="655" src="images/create-tenant-2.png" width="619" /></p>
<p>I created a new tenant named <strong>trio</strong>. Now, tenant list has two 
tenants:</p>
<p>
<img class="img-thumbnail" alt="Tenant list" height="497" src="images/tenant-list-with-2-tenant.png" width="871" /></p>
<p>&nbsp;I can <strong>logout</strong> and 
login as trio <strong>tenant admin</strong>:</p>
<p>
<img alt="Login as tenant" height="404" src="images/login-as-tenant.png" width="420" /></p>
<p>After login, we see that phone book is empty:</p>
<p>
<img alt="Empty phonebook of new tenant" height="210" src="images/phonebook-empty.png" width="791" /></p>
<p>It's empty because trio tenant has a completely islolated people list. You can 
add people here, logout and login as different teants (you can login as default 
tenant for example). You will see that each tenant 
has an isolated phone book and can not see other's people.</p>
<h3>Conclusion</h3>
<p>In this document, we built a complete example that covers most parts of the 
ASP.NET Zero system. We hope that it will help you to build your own 
application.</p>
<h4>Source Code</h4>
<p>You should <a href="/Prices">purchase</a> ASP.NET Zero in order to get
<strong>source code</strong>. After purchasing, you can get the sample project 
from private Github repository:
<a href="https://github.com/aspnetzero/aspnet-zero-samples">https://github.com/aspnetzero/aspnet-zero-samples</a></p>

</body>

</html>
